# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

---

## Running the System

```bash
# Start the CEO Dashboard
python -m streamlit run app.py

# Run SpecKit validation (must pass before every commit)
python -X utf8 validate_specs.py

# Trigger LinkedIn poster manually
python linkedin_poster.py

# Trigger WhatsApp sender manually
python whatsapp_sender.py

# WhatsApp first-time QR login
python whatsapp_sender.py --login

# Run accounting bridge (reads accounting_status.json)
python odoo_mcp_bridge.py

# Git sync (safe — respects PROTECTED_FILES)
python vault_sync.py sync
```

---

## Architecture

This is a **file-pipeline autonomous agent system**. Files move through folders as their state changes — no database, no message queue. The Streamlit dashboard (`app.py`) is the control plane; all agents are standalone Python scripts launched as isolated subprocesses.

### File Pipeline

```
Drafts/   →   Approved/   →   Done/
```

- `Drafts/` — AI-generated content waiting for CEO review
- `Approved/` — CEO-approved files ready for execution
- `Done/` — Sent/posted files (archived, never re-processed)
- `Needs_Action/` — Task files generated by `agent_brain.py` for CEO decisions
- `Readings/` — Incoming email summaries (written by `watchers/gmail_bridge.py`)

File naming conventions:
- LinkedIn posts: `LinkedIn_Post_{brand}_{YYYYMMDD_HHMMSS}.md`
- WhatsApp messages: `WA_Reply_{YYYYMMDD_HHMMSS}.md` — must start with `WA_` to be picked up by `whatsapp_sender.py`
- Task files: `AI_TASK_*.md`, `WA_TASK_*.md`, `ACCT_TASK_*.md`

### Key Scripts

| Script | Role |
|---|---|
| `app.py` | Streamlit dashboard — control center, never import from other scripts directly except `linkedin_agent.py` (imported via `importlib.util`) |
| `linkedin_agent.py` | Post generator — imported in-process by `app.py` (no subprocess), also runnable standalone |
| `linkedin_poster.py` | Playwright automation — reads `Approved/LinkedIn_Post*.md`, posts to LinkedIn, moves to `Done/` |
| `whatsapp_sender.py` | Playwright automation — reads `Approved/WA_*.md`, sends via WhatsApp Web, moves to `Done/` |
| `agent_brain.py` | Scans `Readings/` and `CEO_Briefing_*.md`, creates task files in `Needs_Action/` |
| `odoo_mcp_bridge.py` | Reads `accounting_status.json`, generates audit summaries, flags overdue invoices |
| `vault_sync.py` | `git add / commit / push` with `PROTECTED_FILES` guard — never stages runtime `.py` files |
| `watchers/gmail_bridge.py` | Gmail API watcher — writes email summaries to `Readings/` |
| `watchers/desktop_watcher.py` | Monitors local filesystem events |

### Data Files

- `accounting_status.json` — Odoo mock data (invoices, expenses, bank balance in PKR). `odoo_mcp_bridge.py` reads this; `app.py` reads it via `load_accounting()` with `_mock_accounting()` fallback.
- `social_updates.json` — Social media activity feed read by the dashboard.

---

## Windows Subprocess Rules (CRITICAL)

All subprocess launches **must** go through `_safe_run()` or `_safe_popen()` defined in `app.py`. Direct `subprocess.run()` with `capture_output=True` + `creationflags` causes **WinError 87** on Windows.

```python
_PY = sys.executable          # ALWAYS use this — never the string "python"
_CREATE_NEW_CONSOLE = 0x00000010

# For output capture (blocking):
_safe_run([_PY, "script.py"], timeout=120)

# For fire-and-forget (non-blocking):
_safe_popen([_PY, "script.py"], detach=True)
```

**`_safe_run`** — uses a temp file for output (never PIPE + creationflags).
**`_safe_popen`** — always uses `subprocess.DEVNULL` for stdout/stderr on Windows; never pass an open file handle alongside `CREATE_NEW_CONSOLE`.

---

## SpecKit — Spec Validation

`/specs/*.spec` files define hard rules. `validate_specs.py` checks them automatically.

```bash
python -X utf8 validate_specs.py   # exit 0 = all CRITICAL pass
```

Run this before every commit. Current rules: **DASH-001 through DASH-010**, **WA-001 through WA-006**, **LI-001 through LI-008**.

When adding new subprocess calls or modifying `_safe_run`/`_safe_popen`, update `specs/app.spec` and add a corresponding check in `validate_specs.py`.

---

## vault_sync.py Safety Guard

`PROTECTED_FILES` in `vault_sync.py` prevents runtime scripts from being overwritten during a `git pull`. Never remove a file from this set without understanding the consequence — overwriting `app.py` while Streamlit is running will crash the dashboard session.

---

## LinkedIn Poster Strategies

`linkedin_poster.py` uses **6 strategies** (index 0–5) to click "Start a post" on LinkedIn. The JS `page.evaluate()` innermost-click strategy is at **index 2 (Strategy 3)** — this is intentional per SpecKit rule LI-005. Do not move it below index 2.

---

## Accounting Mock Fallback

`load_accounting()` in `app.py` **always** returns data. If `accounting_status.json` is missing or malformed, it falls back to `_mock_accounting()` which returns hardcoded PKR figures. The dashboard must never show zeroes.

---

## Workflow Directories

These directories must always exist (even if empty). `vault_sync.py` creates them on sync if missing. Each contains a `.gitkeep` to ensure git tracks the empty folder.

```
Needs_Action/   In_Progress/   Pending_Approval/   Approved/   Done/
Drafts/   Readings/   Plans/   Task/   Commands/   logs/   prompt_history/
```

---

## Cleanup Safety Rules

When performing any "studio cleanup", "reset", or "clear" operation:

**NEVER delete files from:**
- `prompt_history/` — permanent step-by-step development log, irreplaceable documentation
- `logs/` — only truncate `agent_activity.log` (empty the file, do not delete it)
- `specs/` — SpecKit rule definitions
- Any `.py` script at root level or in `watchers/`

**Safe to clear (files only, keep `.gitkeep`):**
- `Drafts/` — generated content
- `Approved/` — queued outbox
- `Done/` — already-sent archive
- `Needs_Action/` — processed task files

If files are accidentally deleted, recover with:
```bash
git checkout <last-good-commit> -- prompt_history/
```
